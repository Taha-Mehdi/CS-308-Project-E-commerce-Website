# Bug Report: Double-Cart Concurrency Failure

**ID:** CART-2025-001
**Title:** Duplicate cart items (double quantity) on user authentication
**Severity:** Critical (Data Corruption / UI Crash)
**Status:** Resolved
**Date Fixed:** December 12, 2025

**Environment:**
* **Frontend:** Next.js (React)
* **Backend:** Node.js (Express)
* **Database:** PostgreSQL (Neon/Drizzle ORM)

## 1. Description
When an unauthenticated user with items in their guest cart logs in or registers a new account, the items are submitted to the backend twice simultaneously. This results in data corruption (duplicate rows causing UI crashes) or logic errors (quantity doubling, e.g., 1 item becomes 2).

## 2. Steps to Reproduce
1.  Open the application in a new incognito window (Guest Session).
2.  Add a product (e.g., "Air Jordan 1", Qty: 1) to the cart.
3.  Navigate to the Login or Register page.
4.  Complete the authentication process.
5.  **Observe:** The cart total shows Qty: 2, or the Cart Page crashes with a React "Duplicate Key" error.

## 3. Expected Result
The guest cart should merge seamlessly with the user's account, resulting in a total quantity of 1 (assuming the account was empty).

## 4. Actual Result
The guest cart was merged twice, resulting in a total quantity of 2. In some cases, two distinct rows were created in the database for the same `(user_id, product_id)` pair.

## 5. Root Cause Analysis
1.  **Race Condition:** The Frontend triggered the "Merge Cart" logic from two places simultaneously: manually in the Page Component (`handleSubmit`) and automatically in the Global Context (`AuthContext`).
2.  **Missing Database Constraint:** The `cart_items` table lacked a `UNIQUE` constraint, allowing duplicate rows for the same product.
3.  **Non-Atomic Backend Logic:** The API used a `SELECT` then `INSERT` pattern which failed to handle concurrent requests safely.

## 6. Resolution
1.  **Database:** Added `UNIQUE INDEX` constraint on `(user_id, product_id)` in `schema.js`.
2.  **Backend:** Refactored `POST /cart/add` to use SQL `ON CONFLICT DO UPDATE` (Atomic Upsert) logic in `cart.js`.
3.  **Frontend:** Removed manual merge logic from `LoginPage.jsx` and `RegisterPage.jsx` to eliminate the double request.