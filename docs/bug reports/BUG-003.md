# Bug Report: Invoice PDF Generation Malformed

**ID:** PDF-GEN-004
**Title:** Invoice PDF fails to generate correctly or produces corrupt file
**Severity:** Medium
**Status:** Fixed
**Date Fixed:** December 12, 2025

**Environment:**
* **Backend:** Node.js / PDFKit
* **Output:** Email Attachment / User Download

## 1. Description
The invoice generation utility (`buildInvoicePdf`) fails to produce a valid PDF document during the order completion process. While the order is successfully placed in the database, the resulting PDF file attached to the confirmation email is either **corrupt, empty (0kb), or unreadable** by standard PDF viewers.

## 2. Steps to Reproduce
1.  Log in and add items to the cart.
2.  Complete the checkout process successfully.
3.  Open the "Order Confirmation" email received.
4.  **Action:** Attempt to download and open the `invoice.pdf` attachment.
5.  **Observe:** The PDF viewer displays an error (e.g., "Failed to load PDF document" or "File corrupted") or shows blank pages.

## 3. Expected Result
The system should generate a complete, well-formatted PDF receipt containing the order details, total cost, and shipping address, which can be opened by any standard PDF reader.

## 4. Actual Result
The generation process completed without throwing an error, but the output buffer contained incomplete or malformed binary data, resulting in a broken file.

## 5. Root Cause Analysis
**Stream Handling Error:** The PDF generation function was resolving the Promise before the data stream had finished writing.
* The code returned the buffer immediately upon "document end" signal, but the underlying stream had not yet flushed all data bytes to the buffer.
* This resulted in a truncated (cut-off) file.

## 6. Resolution
Refactored the `buildInvoicePdf` utility to use proper Stream event listeners.
* **Fix:** Added logic to listen for the stream's `data` and `end` events, ensuring the entire buffer is concatenated and finalized before the function returns.